version: '3'

tasks:
  default:
    desc: show available tasks
    cmds:
      - task --list

  start:
    desc: start the API local server
    cmds:
      - supabase start

  serve:
    desc: serve the API functions locally
    cmds:
      - supabase functions serve api --no-verify-jwt

  dev:local:
    desc: start local Supabase and serve the API functions
    cmds:
      - supabase start
      - supabase functions serve api --no-verify-jwt

  deploy:
    desc: deploy API to production (Supabase)
    cmds:
      - |
        echo ""
        echo "=== Pre-deploy checklist ==="
        echo ""
        read -p "Have you run e2e tests? (task test:e2e:prod) [y/N]: " confirm
        if [[ "$confirm" != "y" && "$confirm" != "Y" ]]; then
          echo ""
          echo "Please run e2e tests first:"
          echo "  task test:e2e:prod"
          echo ""
          echo "Or bypass with: task deploy:force"
          exit 1
        fi
      - supabase secrets set --env-file .env.prod
      - task: supabase:deploy

  deploy:force:
    desc: deploy API without e2e confirmation (use with caution)
    cmds:
      - supabase secrets set --env-file .env.prod
      - task: supabase:deploy

  ###

  supabase:link:
    desc: link local Supabase project to hosted project
    cmds:
      - supabase link --project-ref {{.SUPABASE_PROJECT_REF}}

  supabase:db:push:
    desc: push database migrations to linked Supabase project
    cmds:
      - supabase db push

  supabase:functions:deploy:
    desc: deploy edge functions to linked Supabase project
    cmds:
      - supabase functions deploy api

  supabase:deploy:
    desc: deploy Supabase backend (migrations + functions)
    cmds:
      - task: supabase:db:push
      - task: supabase:functions:deploy

  supabase:init:
    desc: initialize Supabase project (run once)
    cmds:
      - supabase init

  supabase:start:
    desc: start local Supabase emulator
    cmds:
      - supabase start

  supabase:stop:
    desc: stop local Supabase emulator
    cmds:
      - supabase stop

  supabase:status:
    desc: show Supabase emulator status and connection info
    cmds:
      - supabase status

  supabase:reset:
    desc: reset Supabase database and apply schema (local)
    cmds:
      - supabase db reset

  supabase:reset-remote:
    desc: 'reset remote Supabase database (WARNING: deletes all data)'
    cmds:
      - supabase db reset --linked

  supabase:studio:
    desc: open Supabase Studio UI in browser
    cmds:
      - supabase studio

  ###
  # Tests
  ###

  test:
    desc: run unit + local tests (pre-commit)
    cmds:
      - pytest test/unit/ test/local/ -v --env local

  test:unit:
    desc: run unit tests only (no services needed)
    cmds:
      - pytest test/unit/ -v

  test:local:
    desc: run local tests (requires task dev:local)
    cmds:
      - |
        echo "Running local tests..."
        echo "Prerequisites: task dev:local running in another terminal"
        pytest test/local/ -v -m local --env local

  test:local:auto:
    desc: run local tests (auto-starts services)
    cmds:
      - |
        set -e
        echo "=== Starting Supabase ==="
        supabase start || true

        echo "=== Starting functions server in background ==="
        supabase functions serve api --no-verify-jwt &
        SERVE_PID=$!
        sleep 3

        echo "=== Running local tests ==="
        pytest test/local/ -v -m local --env local || TEST_EXIT=$?

        echo "=== Stopping functions server ==="
        kill $SERVE_PID 2>/dev/null || true

        exit ${TEST_EXIT:-0}

  test:multi:
    desc: run multi-repo tests (requires worker + userland running)
    cmds:
      - |
        echo "Running multi-repo tests..."
        echo "Prerequisites: eb-api, eb-worker, eb-userland all running"
        pytest test/multi/ -v -m multi --env local

  test:cloud:
    desc: run cloud tests (requires GCP access)
    cmds:
      - pytest test/cloud/ -v -m cloud --env prod

  test:e2e:local:
    desc: run e2e tests against local environment
    cmds:
      - |
        echo "Running e2e tests against local environment..."
        echo "Prerequisites: supabase running (task start), VMs registered"
        pytest test/e2e/ -v -m e2e -s --env local

  test:e2e:prod:
    desc: run e2e tests against production
    cmds:
      - |
        echo "Running e2e tests against production..."
        pytest test/e2e/ -v -m e2e -s --env prod

  hooks:install:
    desc: install git pre-commit hooks
    cmds:
      - ./scripts/install-hooks.sh
